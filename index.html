<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QA TMS (Quality Assurance Dashboard)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase (compat SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDglMEBLr011isuOTEl8hwu-o23oIM6WUk",
      authDomain: "my-test-tool.firebaseapp.com",
      projectId: "my-test-tool",
      storageBucket: "my-test-tool.firebasestorage.app",
      messagingSenderId: "729796287443",
      appId: "1:729796287443:web:63b40613b74a5809d36d26",
      measurementId: "G-FBLJLHQX34"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();
    window.__fb = {
      auth,
      db,
      functions,
      provider: new firebase.auth.GoogleAuthProvider(),
      onAuthStateChanged: auth.onAuthStateChanged.bind(auth),
      signInWithPopup: auth.signInWithPopup.bind(auth),
      signOut: auth.signOut.bind(auth)
    };
  </script>
  <style>
    .highlight-row {
      background-color: #fef9c3;
      transition: background-color 0.8s ease;
    }
    section[data-section] {
      scroll-margin-top: 96px;
    }
    .drop-indicator-top {
      box-shadow: inset 0 3px 0 0 #3b82f6;
    }
    .drop-indicator-bottom {
      box-shadow: inset 0 -3px 0 0 #3b82f6;
    }
    .row-enter {
      animation: rowEnter 0.35s ease;
    }
    @keyframes rowEnter {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-md bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
      <h1 class="text-2xl font-bold text-slate-900">QA ëŒ€ì‹œë³´ë“œ</h1>
      <p class="text-sm text-slate-500 mt-2">ì‹¤ì‹œê°„ QA Status Reportì— ì ‘ê·¼í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>
      <button id="loginBtn" class="mt-6 w-full px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Googleë¡œ ë¡œê·¸ì¸</button>
        <button id="logoutBtn" class="mt-2 w-full px-4 py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 hidden">ë¡œê·¸ì•„ì›ƒ</button>
      <p id="loginError" class="mt-3 text-xs text-rose-600 hidden"></p>
    </div>
  </div>

  <div id="appRoot" class="max-w-7xl mx-auto p-6 hidden">
    <header class="mb-6 flex items-start justify-between gap-4">
      <div>
      <h1 class="text-3xl font-bold text-slate-900">QA ëŒ€ì‰¬ë³´ë“œ</h1>
        <p class="text-slate-500 text-sm mt-1">Quality Assurance Dashboard - í’ˆì§ˆ ë¦¬ìŠ¤í¬ ì¤‘ì‹¬ ê´€ë¦¬</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="adminPageBtn" type="button" class="hidden px-3 py-2 text-xs rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">ê´€ë¦¬ì í˜ì´ì§€</button>
        <button id="modeBadge" type="button" class="text-xs font-semibold px-3 py-1 rounded-full bg-slate-100 text-slate-600">ë·°ì–´ ëª¨ë“œ</button>
      </div>
    </header>

    <div id="sectionNav" class="sticky top-0 z-30 bg-white/95 backdrop-blur border border-slate-200 rounded-2xl px-4 py-2 mb-4 flex flex-wrap items-center gap-2">
      <span class="text-xs font-semibold text-slate-600">ì„¹ì…˜</span>
      <button data-target="dashboardSection" class="section-link text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600">ëŒ€ì‹œë³´ë“œ</button>
      <button data-target="epicTabsSection" class="section-link text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600">ì—í”½ íƒ­</button>
      <button data-target="reportSection" class="section-link text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600">QA ë¦¬í¬íŠ¸</button>
      <span class="ml-auto text-xs text-slate-400">ìŠ¤í¬ë¡¤ ì‹œ ìƒë‹¨ ê³ ì •</span>
    </div>

    <section id="dashboardSection" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6" data-section>
      <div class="section-content">
      <div class="grid lg:grid-cols-[1.1fr,1fr] gap-6 items-start">
        <div>
          <div class="flex items-center gap-3 mb-4 flex-wrap">
            <h2 id="milestoneTitleDisplay" class="text-3xl font-black text-slate-900 cursor-pointer hover:text-indigo-600 transition-colors">ë§ˆì¼ìŠ¤í†¤ ì œëª©</h2>
            <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">Global Summary</span>
            <a id="milestoneJiraBadge" href="#" target="_blank" rel="noopener" class="hidden text-xs font-semibold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full hover:bg-indigo-100 transition-colors">Jira í˜ì´ì§€ ì´ë™ ğŸ”—</a>
          </div>
          <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm max-w-md">
            <div class="flex items-center gap-4">
              <div class="w-28 h-28">
                <canvas id="milestonePie" height="120"></canvas>
              </div>
              <div class="flex-1">
                <p class="text-xs text-slate-500">ì™„ë£Œ ë¹„ìœ¨</p>
                <p id="milestoneMetricText" class="text-2xl font-black text-slate-900">ì™„ë£Œ 0 / 0.00%</p>
                <div class="mt-4 space-y-2 text-sm">
                  <div class="flex items-center justify-between">
                    <span class="flex items-center gap-2 text-slate-600"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span> ì™„ë£Œ</span>
                    <span id="milestoneLegendComplete" class="font-semibold text-slate-700">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="flex items-center gap-2 text-slate-600"><span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span> ì§„í–‰ ì¤‘</span>
                    <span id="milestoneLegendInProgress" class="font-semibold text-slate-700">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="flex items-center gap-2 text-slate-600"><span class="w-2.5 h-2.5 rounded-full bg-slate-300"></span> í•  ì¼</span>
                    <span id="milestoneLegendTodo" class="font-semibold text-slate-700">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex flex-col gap-4">
        <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
          <div class="flex items-center justify-between">
            <p class="text-xs uppercase text-slate-400">Epic Progress</p>
            <button id="copyEpicLink" title="ì—í”½ ë§í¬ ë³µì‚¬" class="w-9 h-9 inline-flex items-center justify-center border border-slate-300 rounded-lg text-base hover:bg-slate-50">ğŸ”—</button>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <h3 id="epicTitleDisplay" class="text-2xl font-bold text-slate-900 cursor-pointer hover:underline truncate">ì—í”½ 1</h3>
          </div>
          <div class="grid gap-2 mt-3">
            <input id="epicTitleInput" type="text" class="border border-slate-300 rounded-lg px-3 py-2 text-sm w-full" placeholder="ì—í”½ ì œëª© ì…ë ¥">
            <input id="epicJiraUrl" type="url" class="border border-slate-300 rounded-lg px-3 py-2 text-sm w-full" placeholder="ì—í”½ Jira URL">
          </div>
          <div class="flex items-center gap-6 mt-4">
            <div class="text-center">
              <p class="text-xs text-slate-400">Fail</p>
              <p id="epicFailCount" class="text-2xl font-bold text-rose-600">0</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-slate-400">Block</p>
              <p id="epicBlockCount" class="text-2xl font-bold text-amber-600">0</p>
            </div>
          </div>
          <div class="mt-3">
            <p class="text-sm font-medium text-slate-600 mb-2">ëˆ„ì  í”„ë¡œê·¸ë ˆìŠ¤</p>
            <div class="h-4 bg-slate-200 rounded-full overflow-hidden flex">
              <div id="epicBarPass" class="h-full bg-emerald-500 transition-all" style="width:0%"></div>
              <div id="epicBarFail" class="h-full bg-rose-500 transition-all" style="width:0%"></div>
              <div id="epicBarBlock" class="h-full bg-amber-500 transition-all" style="width:0%"></div>
              <div id="epicBarNot" class="h-full bg-slate-300 transition-all" style="width:0%"></div>
            </div>
            <p id="epicProgressText" class="text-sm text-slate-500 mt-1 text-right">0 / 0 ì™„ë£Œ (0%)</p>
          </div>
        </div>
        <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
          <div class="flex items-center justify-between">
            <p class="text-xs uppercase text-slate-400">Task Progress</p>
          </div>
          <div class="mt-3">
            <p class="text-sm font-medium text-slate-600 mb-2">íƒœìŠ¤í¬ ì§„í–‰ë¥ </p>
            <div class="h-4 bg-slate-200 rounded-full overflow-hidden flex">
              <div id="taskBarPass" class="h-full bg-emerald-500 transition-all" style="width:0%"></div>
              <div id="taskBarInProgress" class="h-full bg-blue-500 transition-all" style="width:0%"></div>
              <div id="taskBarTodo" class="h-full bg-slate-300 transition-all" style="width:0%"></div>
            </div>
            <p id="taskProgressText" class="text-sm text-slate-500 mt-1 text-right">0 / 0 ì™„ë£Œ (0%)</p>
          </div>
        </div>
        </div>
      </div>
      </div>
    </section>

    <section id="epicTabsSection" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-4" data-section>
      <div class="section-content">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
        <h2 class="text-lg font-semibold text-slate-700 flex items-center gap-2">
          <img src="epic.svg" alt="Epic" class="w-4 h-4">
          Epic íƒ­
        </h2>
        <div class="ml-auto flex items-center gap-2">
          <button id="addEpicBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">+ ì—í”½ ì¶”ê°€</button>
          <button id="deleteEpicBtn" class="px-3 py-2 bg-rose-50 text-rose-600 rounded-lg text-sm hover:bg-rose-100">ì—í”½ ì‚­ì œ</button>
          <button id="epicEditToggle" class="text-xs font-semibold px-3 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600">í¸ì§‘</button>
        </div>
      </div>
      <div id="epicTabs" class="flex gap-2 overflow-x-auto pb-1 border-b border-slate-200"></div>
      <div class="flex items-center justify-between gap-3 mt-4 mb-2 w-full">
        <h3 class="text-sm font-semibold text-slate-600 flex items-center gap-2">
          <img src="task.svg" alt="Task" class="w-4 h-4">
          Task íƒ­
        </h3>
        <div class="ml-auto flex items-center gap-2">
          <button id="addTaskBtn" class="px-3 py-2 bg-emerald-600 text-white rounded-lg text-sm hover:bg-emerald-700">+ Task ì¶”ê°€</button>
          <button id="deleteTaskBtn" class="px-3 py-2 bg-rose-50 text-rose-600 rounded-lg text-sm hover:bg-rose-100">Task ì‚­ì œ</button>
          <button id="taskEditToggle" class="text-xs font-semibold px-3 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600">í¸ì§‘</button>
        </div>
      </div>
      <div id="taskTabs" class="flex gap-2 overflow-x-auto pb-1 border-b border-slate-200"></div>
      </div>
    </section>


    <section id="reportSection" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6" data-section>
      <div class="section-content">
      <div id="summaryHeader" class="mb-4"></div>
      <div id="reportTabs" class="flex items-center gap-2 mb-3">
        <button data-report-tab="test-cases" class="px-3 py-2 text-xs rounded-lg border bg-slate-900 text-white">Test Cases</button>
        <button data-report-tab="status-report" class="px-3 py-2 text-xs rounded-lg border bg-white text-slate-600 border-slate-200 hover:bg-slate-50">Status Report</button>
      </div>
      <div id="testCasesPanel">
        <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
          <div class="flex flex-wrap items-center gap-2">
            <h2 class="text-lg font-semibold text-slate-700">Test Case</h2>
            <span id="tcCount" class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">0ê±´</span>
            <div id="tcFilterTabs" class="flex items-center gap-1 bg-slate-100 rounded-full p-1"></div>
          </div>
          <div class="flex items-center gap-2">
            <button id="importCsvBtn" class="px-3 py-2 border border-slate-200 text-slate-600 rounded-lg text-sm hover:bg-slate-50">CSV ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="exportCsvBtn" class="px-3 py-2 border border-slate-200 text-slate-600 rounded-lg text-sm hover:bg-slate-50">CSV ë‚´ë³´ë‚´ê¸°</button>
            <input id="csvFileInput" type="file" accept=".csv,.txt" class="hidden">
            <button id="addTcBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">+ ìƒˆ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€</button>
            <button id="tableEditToggle" class="text-xs font-semibold px-3 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600">í¸ì§‘</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full min-w-[1100px] text-xs">
            <thead>
              <tr class="border-b border-slate-200 text-slate-600">
                <th class="text-left py-3 px-2 w-12">No.</th>
                <th class="text-left py-3 px-2 w-40">ì¤‘ë¶„ë¥˜</th>
                <th class="text-left py-3 px-2 w-44">Precondition</th>
                <th class="text-left py-3 px-2 w-52">í…ŒìŠ¤íŠ¸ ë‚´ìš©</th>
                <th class="text-left py-3 px-2 w-64">ê¸°ëŒ€ ê²°ê³¼</th>
                <th class="text-left py-3 px-2 w-32">ê²°ê³¼</th>
                <th class="text-left py-3 px-2 w-56">ë©”ëª¨</th>
                <th class="text-left py-3 px-2 w-12">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="tcBody"></tbody>
          </table>
        </div>
      </div>
      <div id="insightsPanel" class="hidden">
        <div id="insightsContent" class="space-y-5"></div>
      </div>
      </div>
    </section>

    <section id="adminSection" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mt-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold text-slate-700">ê´€ë¦¬ì í˜ì´ì§€</h2>
          <p class="text-xs text-slate-500">ê¶Œí•œ ìš”ì²­ ëª©ë¡ì„ ìŠ¹ì¸/ê±°ì ˆí•©ë‹ˆë‹¤.</p>
        </div>
        <button id="adminBackBtn" class="px-3 py-2 text-xs rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-xs">
          <thead>
            <tr class="border-b border-slate-200 text-slate-600">
              <th class="text-left py-3 px-2 w-56">ì´ë©”ì¼</th>
              <th class="text-left py-3 px-2 w-24">ìš”ì²­</th>
              <th class="text-left py-3 px-2 w-24">ìƒíƒœ</th>
              <th class="text-left py-3 px-2 w-40">ìš”ì²­ì¼</th>
              <th class="text-left py-3 px-2 w-40">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="adminRequestsBody"></tbody>
        </table>
        <p id="adminEmpty" class="text-xs text-slate-500 mt-3 hidden">ì²˜ë¦¬í•  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    </section>
  </div>

  <div id="requestModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md border border-slate-200">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
        <h3 class="text-lg font-semibold text-slate-800">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <button id="requestModalClose" class="w-8 h-8 rounded-lg text-slate-500 hover:bg-slate-100">âœ•</button>
      </div>
      <div class="px-5 py-4 space-y-3 text-sm text-slate-600">
        <p>ê¶Œí•œ ìš”ì²­ì„ ì§„í–‰í•˜ë©´ ê´€ë¦¬ìê°€ ìŠ¹ì¸ í›„ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <p id="requestStatus" class="text-xs text-slate-500"></p>
      </div>
      <div class="flex items-center justify-end gap-2 px-5 py-4 border-t border-slate-100">
        <button id="requestViewerBtn" class="px-4 py-2 text-sm rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">ë·°ì–´ ê¶Œí•œ ìš”ì²­</button>
        <button id="requestAdminBtn" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">ê´€ë¦¬ì ê¶Œí•œ ìš”ì²­</button>
      </div>
    </div>
  </div>

  <div id="milestoneModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md border border-slate-200">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
        <h3 class="text-lg font-semibold text-slate-800">ë§ˆì¼ìŠ¤í†¤ ì •ë³´ ìˆ˜ì •</h3>
        <button id="milestoneModalClose" class="w-8 h-8 rounded-lg text-slate-500 hover:bg-slate-100">âœ•</button>
      </div>
      <div class="px-5 py-4 space-y-4">
        <div>
          <label class="text-xs text-slate-500">ë§ˆì¼ìŠ¤í†¤ ì œëª©</label>
          <input id="milestoneModalTitleInput" type="text" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="ë§ˆì¼ìŠ¤í†¤ ì œëª© ì…ë ¥">
        </div>
        <div>
          <label class="text-xs text-slate-500">ë§ˆì¼ìŠ¤í†¤ Jira URL</label>
          <input id="milestoneModalJiraInput" type="url" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="ë§ˆì¼ìŠ¤í†¤ Jira URL">
        </div>
      </div>
      <div class="flex items-center justify-end gap-2 px-5 py-4 border-t border-slate-100">
        <button id="milestoneModalCancel" class="px-4 py-2 text-sm rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">ì·¨ì†Œ</button>
        <button id="milestoneModalSave" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">ì €ì¥</button>
      </div>
    </div>
  </div>

  <div id="adminLoginModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-sm border border-slate-200">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
        <h3 class="text-lg font-semibold text-slate-800">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
        <button id="adminLoginClose" class="w-8 h-8 rounded-lg text-slate-500 hover:bg-slate-100">âœ•</button>
      </div>
      <div class="px-5 py-4 space-y-4">
        <div>
          <label class="text-xs text-slate-500">ì•„ì´ë””</label>
          <input id="adminLoginId" type="text" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="ì•„ì´ë””">
        </div>
        <div>
          <label class="text-xs text-slate-500">ë¹„ë°€ë²ˆí˜¸</label>
          <input id="adminLoginPw" type="password" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="ë¹„ë°€ë²ˆí˜¸">
        </div>
        <p id="adminLoginError" class="text-xs text-rose-600 hidden">ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="flex items-center justify-end gap-2 px-5 py-4 border-t border-slate-100">
        <button id="adminLoginCancel" class="px-4 py-2 text-sm rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">ì·¨ì†Œ</button>
        <button id="adminLoginSubmit" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">ë¡œê·¸ì¸</button>
      </div>
    </div>
  </div>

  <div id="adminLogoutModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-sm border border-slate-200">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
        <h3 class="text-lg font-semibold text-slate-800">ê´€ë¦¬ì ëª¨ë“œ</h3>
        <button id="adminLogoutClose" class="w-8 h-8 rounded-lg text-slate-500 hover:bg-slate-100">âœ•</button>
      </div>
      <div class="px-5 py-4">
        <p class="text-sm text-slate-600">ë·°ì–´ ëª¨ë“œë¡œ ì „í™˜í• ê¹Œìš”?</p>
      </div>
      <div class="flex items-center justify-end gap-2 px-5 py-4 border-t border-slate-100">
        <button id="adminLogoutCancel" class="px-4 py-2 text-sm rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">ì·¨ì†Œ</button>
        <button id="adminLogoutConfirm" class="px-4 py-2 text-sm rounded-lg bg-rose-600 text-white hover:bg-rose-700">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <div id="reportModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-sm border border-slate-200">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
        <h3 class="text-lg font-semibold text-slate-800">Report ìš”ì•½</h3>
        <button id="reportModalClose" class="w-8 h-8 rounded-lg text-slate-500 hover:bg-slate-100">âœ•</button>
      </div>
      <div id="reportModalBody" class="px-5 py-4 text-sm text-slate-700"></div>
      <div class="flex items-center justify-end px-5 py-4 border-t border-slate-100">
        <button id="reportModalOk" class="px-4 py-2 text-sm rounded-lg bg-slate-900 text-white hover:bg-slate-800">ë‹«ê¸°</button>
      </div>
    </div>
  </div>


  <div id="newTcModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl border border-slate-200">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
        <h3 id="newTcModalTitle" class="text-lg font-semibold text-slate-800">ì‹ ê·œ TC ë“±ë¡</h3>
        <button id="newTcModalClose" class="w-8 h-8 rounded-lg text-slate-500 hover:bg-slate-100">âœ•</button>
      </div>
      <div class="px-5 py-4 space-y-4">
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-500">ì¤‘ë¶„ë¥˜</label>
            <input id="newTcMiddle" type="text" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="ì¤‘ë¶„ë¥˜">
          </div>
          <div>
            <label class="text-xs text-slate-500">Precondition</label>
            <input id="newTcPrecondition" type="text" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="Precondition">
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-500">í…ŒìŠ¤íŠ¸ ë‚´ìš©</label>
            <textarea id="newTcContent" rows="4" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm resize-none" placeholder="í…ŒìŠ¤íŠ¸ ë‚´ìš©"></textarea>
          </div>
          <div>
            <label class="text-xs text-slate-500">ê¸°ëŒ€ ê²°ê³¼</label>
            <textarea id="newTcExpected" rows="4" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm resize-none" placeholder="ê¸°ëŒ€ ê²°ê³¼"></textarea>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-500">ê²°ê³¼</label>
            <select id="newTcStatus" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white">
              <option value="not_test" selected>Not Test</option>
              <option value="pass">Pass</option>
              <option value="fail">Fail</option>
              <option value="block">Block</option>
              <option value="na">N/A</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-500">ë©”ëª¨</label>
            <input id="newTcMemo" type="text" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="ë©”ëª¨">
          </div>
        </div>
      </div>
      <div class="flex items-center justify-end gap-2 px-5 py-4 border-t border-slate-100">
        <button id="newTcModalCancel" class="px-4 py-2 text-sm rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">ì·¨ì†Œ</button>
        <button id="newTcModalSave" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">ì €ì¥</button>
      </div>
    </div>
  </div>

  <div id="issueModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-xl border border-slate-200">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
        <h3 class="text-lg font-semibold text-slate-800">ì´ìŠˆ ë“±ë¡</h3>
        <button id="issueModalClose" class="w-8 h-8 rounded-lg text-slate-500 hover:bg-slate-100">âœ•</button>
      </div>
      <div class="px-5 py-4 space-y-4">
        <div>
          <label class="text-xs text-slate-500">ì œëª©</label>
          <input id="issueTitleInput" type="text" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="ì´ìŠˆ ì œëª©">
        </div>
        <div>
          <label class="text-xs text-slate-500">ë‚´ìš©</label>
          <textarea id="issueContentInput" rows="4" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm resize-none" placeholder="ì´ìŠˆ ë‚´ìš©"></textarea>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-500">ì¤‘ìš”ë„</label>
            <select id="issueSeverityInput" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-500">ì²¨ë¶€íŒŒì¼</label>
            <input id="issueAttachmentInput" type="file" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white">
            <p id="issueAttachmentNote" class="mt-1 text-xs text-slate-400"></p>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-end gap-2 px-5 py-4 border-t border-slate-100">
        <button id="issueModalCancel" class="px-4 py-2 text-sm rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">ì·¨ì†Œ</button>
        <button id="issueModalSave" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">ë“±ë¡</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = 'qa_tms_state_v1';
      const DEFAULT_MILESTONE_TITLE = 'ë§ˆì¼ìŠ¤í†¤ ì œëª©';

      const state = loadState();
      const fb = window.__fb || (() => {
        if (!window.firebase || !window.firebase.auth) return null;
        const auth = window.firebase.auth();
        const db = window.firebase.firestore ? window.firebase.firestore() : null;
        const functions = window.firebase.functions ? window.firebase.functions() : null;
        return {
          auth,
          db,
          functions,
          provider: new window.firebase.auth.GoogleAuthProvider(),
          onAuthStateChanged: auth.onAuthStateChanged.bind(auth),
          signInWithPopup: auth.signInWithPopup.bind(auth),
          signOut: auth.signOut.bind(auth)
        };
      })();
      const ADMIN_EMAIL = "yuyu427j@gmail.com";
      let isAdmin = false;
      let isAuthBusy = false;
      let milestonePieChart = null;
      let lastAddedTcId = null;
      let editTcId = null;
      let issueTcId = null;
      let isTableEditMode = false;
      let isEpicEditMode = false;
      let isTaskEditMode = false;
      let statusFilter = null;
      let activeSummaryAction = 'all';
      let activeReportTab = 'test-cases';
      const els = {
        appRoot: document.getElementById('appRoot'),
        loginScreen: document.getElementById('loginScreen'),
        loginBtn: document.getElementById('loginBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        loginError: document.getElementById('loginError'),
        requestModal: document.getElementById('requestModal'),
        requestModalClose: document.getElementById('requestModalClose'),
        requestViewerBtn: document.getElementById('requestViewerBtn'),
        requestAdminBtn: document.getElementById('requestAdminBtn'),
        requestStatus: document.getElementById('requestStatus'),
        milestoneTitleDisplay: document.getElementById('milestoneTitleDisplay'),
        modeBadge: document.getElementById('modeBadge'),
        adminPageBtn: document.getElementById('adminPageBtn'),
        milestoneJiraBadge: document.getElementById('milestoneJiraBadge'),
        milestoneModal: document.getElementById('milestoneModal'),
        milestoneModalTitleInput: document.getElementById('milestoneModalTitleInput'),
        milestoneModalJiraInput: document.getElementById('milestoneModalJiraInput'),
        milestoneModalSave: document.getElementById('milestoneModalSave'),
        milestoneModalCancel: document.getElementById('milestoneModalCancel'),
        milestoneModalClose: document.getElementById('milestoneModalClose'),
        milestonePie: document.getElementById('milestonePie'),
        milestoneMetricText: document.getElementById('milestoneMetricText'),
        milestoneLegendComplete: document.getElementById('milestoneLegendComplete'),
        milestoneLegendInProgress: document.getElementById('milestoneLegendInProgress'),
        milestoneLegendTodo: document.getElementById('milestoneLegendTodo'),
        taskBarPass: document.getElementById('taskBarPass'),
        taskBarInProgress: document.getElementById('taskBarInProgress'),
        taskBarTodo: document.getElementById('taskBarTodo'),
        taskProgressText: document.getElementById('taskProgressText'),
        newTcModal: document.getElementById('newTcModal'),
        newTcModalTitle: document.getElementById('newTcModalTitle'),
        newTcModalClose: document.getElementById('newTcModalClose'),
        newTcModalCancel: document.getElementById('newTcModalCancel'),
        newTcModalSave: document.getElementById('newTcModalSave'),
        newTcMiddle: document.getElementById('newTcMiddle'),
        newTcPrecondition: document.getElementById('newTcPrecondition'),
        newTcContent: document.getElementById('newTcContent'),
        newTcExpected: document.getElementById('newTcExpected'),
        newTcStatus: document.getElementById('newTcStatus'),
        newTcMemo: document.getElementById('newTcMemo'),
        issueModal: document.getElementById('issueModal'),
        issueModalClose: document.getElementById('issueModalClose'),
        issueModalCancel: document.getElementById('issueModalCancel'),
        issueModalSave: document.getElementById('issueModalSave'),
        issueTitleInput: document.getElementById('issueTitleInput'),
        issueContentInput: document.getElementById('issueContentInput'),
        issueSeverityInput: document.getElementById('issueSeverityInput'),
        issueAttachmentInput: document.getElementById('issueAttachmentInput'),
        issueAttachmentNote: document.getElementById('issueAttachmentNote'),
        adminLoginModal: document.getElementById('adminLoginModal'),
        adminLoginClose: document.getElementById('adminLoginClose'),
        adminLoginCancel: document.getElementById('adminLoginCancel'),
        adminLoginSubmit: document.getElementById('adminLoginSubmit'),
        adminLoginId: document.getElementById('adminLoginId'),
        adminLoginPw: document.getElementById('adminLoginPw'),
        adminLoginError: document.getElementById('adminLoginError'),
        adminLogoutModal: document.getElementById('adminLogoutModal'),
        adminLogoutClose: document.getElementById('adminLogoutClose'),
        adminLogoutCancel: document.getElementById('adminLogoutCancel'),
        adminLogoutConfirm: document.getElementById('adminLogoutConfirm'),
        reportModal: document.getElementById('reportModal'),
        reportModalClose: document.getElementById('reportModalClose'),
        reportModalOk: document.getElementById('reportModalOk'),
        reportModalBody: document.getElementById('reportModalBody'),
        reportTabs: document.getElementById('reportTabs'),
        testCasesPanel: document.getElementById('testCasesPanel'),
        insightsPanel: document.getElementById('insightsPanel'),
        insightsContent: document.getElementById('insightsContent'),
        adminSection: document.getElementById('adminSection'),
        adminBackBtn: document.getElementById('adminBackBtn'),
        adminRequestsBody: document.getElementById('adminRequestsBody'),
        adminEmpty: document.getElementById('adminEmpty'),
        tcFilterTabs: document.getElementById('tcFilterTabs'),
        epicTabs: document.getElementById('epicTabs'),
        taskTabs: document.getElementById('taskTabs'),
        epicEditToggle: document.getElementById('epicEditToggle'),
        taskEditToggle: document.getElementById('taskEditToggle'),
        epicTitleDisplay: document.getElementById('epicTitleDisplay'),
        epicTitleInput: document.getElementById('epicTitleInput'),
        epicJiraUrl: document.getElementById('epicJiraUrl'),
        epicFailCount: document.getElementById('epicFailCount'),
        epicBlockCount: document.getElementById('epicBlockCount'),
        epicBarPass: document.getElementById('epicBarPass'),
        epicBarFail: document.getElementById('epicBarFail'),
        epicBarBlock: document.getElementById('epicBarBlock'),
        epicBarNot: document.getElementById('epicBarNot'),
        epicProgressText: document.getElementById('epicProgressText'),
        tcBody: document.getElementById('tcBody'),
        tcCount: document.getElementById('tcCount'),
        summaryHeader: document.getElementById('summaryHeader'),
        reportSection: document.getElementById('reportSection'),
        tableEditToggle: document.getElementById('tableEditToggle'),
        addEpicBtn: document.getElementById('addEpicBtn'),
        deleteEpicBtn: document.getElementById('deleteEpicBtn'),
        addTaskBtn: document.getElementById('addTaskBtn'),
        deleteTaskBtn: document.getElementById('deleteTaskBtn'),
        addTcBtn: document.getElementById('addTcBtn'),
        importCsvBtn: document.getElementById('importCsvBtn'),
        exportCsvBtn: document.getElementById('exportCsvBtn'),
        csvFileInput: document.getElementById('csvFileInput'),
        copyEpicLink: document.getElementById('copyEpicLink')
      };

      const projectId = fb && fb.db && fb.db.app ? fb.db.app.options.projectId : null;

      function showLoginScreen() {
        if (els.loginScreen) els.loginScreen.classList.remove('hidden');
        if (els.appRoot) els.appRoot.classList.add('hidden');
      }

      function showApp() {
        if (els.loginScreen) els.loginScreen.classList.add('hidden');
        if (els.appRoot) els.appRoot.classList.remove('hidden');
        if (els.adminSection) els.adminSection.classList.add('hidden');
        if (els.reportSection) els.reportSection.classList.remove('hidden');
      }

      function showAdminSection() {
        if (els.adminSection) els.adminSection.classList.remove('hidden');
        if (els.reportSection) els.reportSection.classList.add('hidden');
      }

      function openRequestModal() {
        if (!els.requestModal) return;
        els.requestModal.classList.remove('hidden');
        els.requestModal.classList.add('flex');
      }

      function closeRequestModal() {
        if (!els.requestModal) return;
        els.requestModal.classList.add('hidden');
        els.requestModal.classList.remove('flex');
      }

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          return {
            milestoneTitle: DEFAULT_MILESTONE_TITLE,
            milestoneJiraUrl: '',
            epics: [{ id: createId('epic'), name: 'ì—í”½ 1', jiraUrl: '', tasks: [{ id: createId('task'), name: 'Task 1', tcs: [] }] }],
            activeEpicId: null,
            activeTaskId: null,
            tcCounter: 0
          };
        }
        try {
          const parsed = JSON.parse(raw);
          if (!parsed.epics || parsed.epics.length === 0) {
            parsed.epics = [{ id: createId('epic'), name: 'ì—í”½ 1', jiraUrl: '', tasks: [{ id: createId('task'), name: 'Task 1', tcs: [] }] }];
          }
          parsed.epics.forEach(epic => {
            if (!epic.tasks) {
              const legacyTcs = epic.tcs || [];
              if (legacyTcs.length > 0) {
                epic.tasks = [{ id: createId('task'), name: 'Task 1', tcs: legacyTcs }];
              } else {
                epic.tasks = [];
              }
              delete epic.tcs;
            }
          });
          parsed.milestoneTitle = parsed.milestoneTitle || DEFAULT_MILESTONE_TITLE;
          return parsed;
        } catch (err) {
          return {
            milestoneTitle: DEFAULT_MILESTONE_TITLE,
            milestoneJiraUrl: '',
            epics: [{ id: createId('epic'), name: 'ì—í”½ 1', jiraUrl: '', tasks: [{ id: createId('task'), name: 'Task 1', tcs: [] }] }],
            activeEpicId: null,
            activeTaskId: null,
            tcCounter: 0
          };
        }
      }

      function persist() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (err) {
          console.error('ì €ì¥ ì‹¤íŒ¨', err);
          alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        }
      }

      function createId(prefix) {
        return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
      }

      function getActiveEpic() {
        let epic = state.epics.find(e => e.id === state.activeEpicId);
        if (!epic) {
          state.activeEpicId = state.epics[0].id;
          epic = state.epics[0];
        }
        return epic;
      }

      function getActiveTask() {
        const epic = getActiveEpic();
        epic.tasks = epic.tasks || [];
        if (epic.tasks.length === 0) {
          state.activeTaskId = null;
          return null;
        }
        let task = epic.tasks.find(t => t.id === state.activeTaskId);
        if (!task) {
          state.activeTaskId = epic.tasks[0].id;
          task = epic.tasks[0];
        }
        return task;
      }

      function countStatuses(tcs) {
        let pass = 0;
        let fail = 0;
        let block = 0;
        let notTest = 0;
        let na = 0;
        tcs.forEach(tc => {
          if (tc.status === 'pass') pass += 1;
          else if (tc.status === 'fail') fail += 1;
          else if (tc.status === 'block') block += 1;
          else if (tc.status === 'na') na += 1;
          else notTest += 1;
        });
        return { pass, fail, block, notTest, na };
      }

      function renderEpicTabs() {
        els.epicTabs.innerHTML = '';
        state.epics.forEach(epic => {
          const isActive = epic.id === state.activeEpicId;
          const btn = document.createElement('button');
          btn.className = 'px-3 py-2 rounded-lg text-sm border whitespace-nowrap ' +
            (isActive ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50');
          btn.textContent = epic.name;
          btn.addEventListener('click', () => {
            state.activeEpicId = epic.id;
            const firstTask = epic.tasks && epic.tasks[0];
            state.activeTaskId = firstTask ? firstTask.id : null;
            persist();
            renderAll();
          });
          btn.addEventListener('dblclick', () => {
            if (!isAdmin || !isEpicEditMode) return;
            const name = prompt('ì—í”½ ì œëª©ì„ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.', epic.name);
            if (!name) return;
            epic.name = name.trim();
            persist();
            renderAll();
          });
          els.epicTabs.appendChild(btn);
        });
      }

      function renderTaskTabs() {
        const epic = getActiveEpic();
        epic.tasks = epic.tasks || [];
        els.taskTabs.innerHTML = '';
        (epic.tasks || []).forEach(task => {
          const isActive = task.id === state.activeTaskId;
          const btn = document.createElement('button');
          btn.className = 'px-3 py-2 rounded-lg text-sm border whitespace-nowrap ' +
            (isActive ? 'bg-white text-indigo-700 border-indigo-300' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50');
          btn.textContent = task.name;
          btn.addEventListener('click', () => {
            state.activeTaskId = task.id;
            persist();
            renderAll();
          });
          btn.addEventListener('dblclick', () => {
            if (!isAdmin || !isTaskEditMode) return;
            const name = prompt('Task ì œëª©ì„ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.', task.name);
            if (!name) return;
            task.name = name.trim();
            persist();
            renderAll();
          });
          els.taskTabs.appendChild(btn);
        });
        // task add button handled in header
        if (epic.tasks.length > 0 && !state.activeTaskId) {
          state.activeTaskId = epic.tasks[0].id;
        }
        applyEpicTaskEditUI();
      }

      function applyEpicTaskEditUI() {
        const hideEpic = !isAdmin || !isEpicEditMode;
        const epic = getActiveEpic();
        const taskCount = (epic.tasks || []).length;
        const forceShowAddTask = isAdmin && taskCount === 0;
        const hideTask = !isAdmin || (!isTaskEditMode && !forceShowAddTask);
        els.addEpicBtn.classList.toggle('invisible', hideEpic);
        els.deleteEpicBtn.classList.toggle('invisible', hideEpic);
        els.addEpicBtn.classList.toggle('pointer-events-none', hideEpic);
        els.deleteEpicBtn.classList.toggle('pointer-events-none', hideEpic);
        els.addTaskBtn.classList.toggle('invisible', hideTask);
        els.addTaskBtn.classList.toggle('pointer-events-none', hideTask);
        els.deleteTaskBtn.classList.toggle('invisible', hideTask);
        els.deleteTaskBtn.classList.toggle('pointer-events-none', hideTask);
        if (els.taskEditToggle) {
          const hideTaskToggle = !isAdmin || taskCount === 0;
          els.taskEditToggle.classList.toggle('hidden', hideTaskToggle);
        }
        if (taskCount === 0) {
          els.deleteTaskBtn.classList.add('invisible', 'pointer-events-none');
        }
      }

      function renderGlobalDashboard() {
        const allTcs = state.epics.flatMap(e => (e.tasks || []).flatMap(t => t.tcs || []));
        const counts = countStatuses(allTcs);
        const total = allTcs.length;
        const complete = counts.pass;
        const inProgress = counts.fail + counts.block;
        const todo = counts.notTest;
        const pct = total ? (complete / total) * 100 : 0;

        els.milestoneMetricText.textContent = `ì™„ë£Œ ${complete} / ${pct.toFixed(2)}%`;
        els.milestoneLegendComplete.textContent = complete;
        els.milestoneLegendInProgress.textContent = inProgress;
        els.milestoneLegendTodo.textContent = todo;

        const activeTask = getActiveTask();
        const taskCounts = countStatuses(activeTask ? (activeTask.tcs || []) : []);
        const taskTotal = activeTask ? (activeTask.tcs || []).length : 0;
        const taskComplete = taskCounts.pass;
        const taskInProgress = taskCounts.fail + taskCounts.block;
        const taskTodo = taskCounts.notTest;
        const taskPct = taskTotal ? (taskComplete / taskTotal) * 100 : 0;
        const passPct = taskTotal ? (taskComplete / taskTotal) * 100 : 0;
        const inProgressPct = taskTotal ? (taskInProgress / taskTotal) * 100 : 0;
        const todoPct = taskTotal ? (taskTodo / taskTotal) * 100 : 0;
        if (els.taskBarPass) els.taskBarPass.style.width = passPct + '%';
        if (els.taskBarInProgress) els.taskBarInProgress.style.width = inProgressPct + '%';
        if (els.taskBarTodo) els.taskBarTodo.style.width = todoPct + '%';
        if (els.taskProgressText) {
          els.taskProgressText.textContent = `${taskComplete} / ${taskTotal} ì™„ë£Œ (${Math.round(taskPct)}%)`;
        }

        if (!milestonePieChart) {
          const ctx = els.milestonePie.getContext('2d');
          milestonePieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['ì™„ë£Œ', 'ì§„í–‰ ì¤‘', 'í•  ì¼'],
              datasets: [{
                data: [complete, inProgress, todo],
                backgroundColor: ['#22c55e', '#3b82f6', '#cbd5e1'],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              cutout: '70%',
              plugins: { legend: { display: false } }
            }
          });
        } else {
          milestonePieChart.data.datasets[0].data = [complete, inProgress, todo];
          milestonePieChart.update('none');
        }
      }

      function renderEpicDashboard() {
        const epic = getActiveEpic();
        els.epicTitleDisplay.textContent = epic.name;
        if (els.epicTitleInput) els.epicTitleInput.value = epic.name;
        if (els.epicJiraUrl) els.epicJiraUrl.value = epic.jiraUrl || '';

        const epicTcs = (epic.tasks || []).flatMap(t => t.tcs || []);
        const counts = countStatuses(epicTcs);
        const done = counts.pass + counts.fail + counts.block;
        const total = epicTcs.length;
        const pct = total ? Math.round((done / total) * 100) : 0;

        els.epicFailCount.textContent = counts.fail;
        els.epicBlockCount.textContent = counts.block;
        els.epicProgressText.textContent = done + ' / ' + total + ' ì™„ë£Œ (' + pct + '%)';

        const passPct = total ? (counts.pass / total) * 100 : 0;
        const failPct = total ? (counts.fail / total) * 100 : 0;
        const blockPct = total ? (counts.block / total) * 100 : 0;
        const notPct = total ? (counts.notTest / total) * 100 : 0;

        els.epicBarPass.style.width = passPct + '%';
        els.epicBarFail.style.width = failPct + '%';
        els.epicBarBlock.style.width = blockPct + '%';
        els.epicBarNot.style.width = notPct + '%';
      }

      function createStatusSelect(value) {
        const select = document.createElement('select');
        select.className = 'border border-slate-300 rounded-lg px-2 py-1 text-sm bg-white';
        const options = [
          { value: 'not_test', label: 'Not Tested' },
          { value: 'pass', label: 'Pass' },
          { value: 'fail', label: 'Fail' },
          { value: 'block', label: 'Block' },
          { value: 'na', label: 'N/A' }
        ];
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          select.appendChild(o);
        });
        select.value = value || 'not_test';
        select.disabled = !isAdmin;
        applyStatusStyle(select);
        return select;
      }

      function applyStatusStyle(select) {
        const base = 'border rounded-lg px-2 py-1 text-sm ';
        const val = select.value;
        if (val === 'pass') {
          select.className = base + 'border-emerald-200 bg-emerald-50 text-emerald-700';
        } else if (val === 'fail') {
          select.className = base + 'border-rose-200 bg-rose-50 text-rose-700';
        } else if (val === 'block') {
          select.className = base + 'border-amber-200 bg-amber-50 text-amber-700';
        } else if (val === 'na') {
          select.className = base + 'border-slate-200 bg-slate-50 text-slate-500';
        } else {
          select.className = base + 'border-slate-200 bg-slate-100 text-slate-600';
        }
      }

      function computeTaskStats(task) {
        const counts = countStatuses(task ? (task.tcs || []) : []);
        const total = task ? (task.tcs || []).length : 0;
        const passRate = total ? Math.round((counts.pass / total) * 100) : 0;
        return {
          total,
          pass: counts.pass,
          fail: counts.fail,
          block: counts.block,
          notTest: counts.notTest,
          na: counts.na,
          passRate
        };
      }

      function renderSummaryHeader(container, props) {
        if (!container) return;
        const { breadcrumb, stats, releaseSignal, activeAction } = props;
        const safePassRate = Math.max(0, Math.min(100, Number(stats.passRate) || 0));
        const totalCount = Number(stats.total) || 0;
        const segments = [
          { key: 'pass', value: Number(stats.pass) || 0, className: 'bg-emerald-500' },
          { key: 'fail', value: Number(stats.fail) || 0, className: 'bg-rose-500' },
          { key: 'block', value: Number(stats.block) || 0, className: 'bg-amber-500' },
          { key: 'notTest', value: Number(stats.notTest) || 0, className: 'bg-slate-400' },
          { key: 'na', value: Number(stats.na) || 0, className: 'bg-slate-300' }
        ];
        const segmentWidths = totalCount > 0
          ? segments.map(seg => Math.max(0, (seg.value / totalCount) * 100))
          : segments.map(() => 0);
        const baseBtn = 'px-3 py-2 text-xs rounded-lg border';
        const isActive = (action) => action === activeAction;
        const btnClass = (action) => isActive(action)
          ? 'px-3 py-2 text-xs rounded-lg bg-slate-900 text-white'
          : 'px-3 py-2 text-xs rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50';
        container.innerHTML = `
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
            <div class="mb-4">
              <p class="text-xs text-slate-500">Breadcrumb</p>
              <p class="text-sm font-semibold text-slate-700">${breadcrumb}</p>
            </div>
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div class="flex-1 min-w-[260px]">
                <p class="text-xs text-slate-500 mb-2">Quality Snapshot</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs text-slate-600">
                  <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-2 py-1"><span>Total</span><strong>${stats.total}</strong></div>
                  <div class="flex items-center justify-between bg-white border border-emerald-200 rounded-lg px-2 py-1"><span>Pass</span><strong>${stats.pass}</strong></div>
                  <div class="flex items-center justify-between bg-white border border-rose-200 rounded-lg px-2 py-1"><span>Fail</span><strong>${stats.fail}</strong></div>
                  <div class="flex items-center justify-between bg-white border border-amber-200 rounded-lg px-2 py-1"><span>Block</span><strong>${stats.block}</strong></div>
                  <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-2 py-1"><span>Not Tested</span><strong>${stats.notTest}</strong></div>
                  <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-2 py-1"><span>N/A</span><strong>${stats.na}</strong></div>
                </div>
                <div class="mt-3">
                  <div class="flex items-center justify-between text-xs text-slate-500 mb-1">
                    <span>Pass Rate</span>
                    <strong class="text-slate-700">${safePassRate}%</strong>
                  </div>
                  <div class="w-full h-2 rounded-full bg-slate-200 overflow-hidden">
                    <div class="h-full rounded-full bg-emerald-500" style="width: ${safePassRate}%"></div>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="flex items-center justify-between text-xs text-slate-500 mb-1">
                    <span>Status Ratio</span>
                    <strong class="text-slate-700">${totalCount}</strong>
                  </div>
                  <div class="w-full h-2 rounded-full bg-slate-200 overflow-hidden flex">
                    ${segments.map((seg, idx) => `
                      <div class="h-full ${seg.className}" style="width: ${segmentWidths[idx]}%"></div>
                    `).join('')}
                  </div>
                </div>
              </div>
              <div class="min-w-[220px]">
                <p class="text-xs text-slate-500 mb-2">Release Signal</p>
                <p class="text-sm font-semibold text-slate-700">${releaseSignal.headline}</p>
                <p class="text-xs text-slate-500 mt-1">${releaseSignal.sub}</p>
                <div class="mt-3">
                  <button data-action="issues-link" class="text-xs text-indigo-600 hover:underline">Issues ë³´ê¸°</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function getReleaseSignal(stats) {
        if (stats.block > 0) {
          return {
            headline: 'âš ï¸ Block ì¼€ì´ìŠ¤ê°€ ìˆì–´ ì§„í–‰ì— ì œì•½ì´ ìˆì–´ìš”',
            sub: '> í™˜ê²½/ê¶Œí•œ/ì˜ì¡´ ì´ìŠˆ í™•ì¸ í›„, í•´ì†Œë˜ë©´ í…ŒìŠ¤íŠ¸ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ìˆì–´ìš”'
          };
        }
        if (stats.fail > 0) {
          return {
            headline: 'âš ï¸ Fail ì¼€ì´ìŠ¤ê°€ ìˆì–´ í™•ì¸ì´ í•„ìš”í•´ìš”',
            sub: '> ê´€ë ¨ ì´ìŠˆë¥¼ í™•ì¸í•˜ê³ , ì¡°ì¹˜ í›„ ì¬ì‹¤í–‰ì„ ê¶Œì¥í•´ìš”'
          };
        }
        const notTestRatio = stats.total ? (stats.notTest / stats.total) : 0;
        if (notTestRatio >= 0.3) {
          return {
            headline: 'ğŸŸ¡ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì€ TCê°€ ë§ì•„ìš”',
            sub: '> ìš°ì„ ìˆœìœ„ë¥¼ ì •í•´ ì ì§„ì ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•´ìš”'
          };
        }
        if (stats.passRate >= 90) {
          return {
            headline: 'âœ… ë¦´ë¦¬ì¦ˆ ê°€ëŠ¥í•´ ë³´ì—¬ìš”',
            sub: '> í•µì‹¬ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í•œ ë²ˆ ë” í™•ì¸í•˜ë©´ ë” ì•ˆì „í•´ìš”'
          };
        }
        return {
          headline: 'ğŸŸ¡ ì§„í–‰ ì¤‘ì´ì—ìš”',
          sub: '> ë‚¨ì€ TC ì‹¤í–‰ê³¼ ê²°ê³¼ í™•ì¸ì„ ê³„ì† ì§„í–‰í•´ ì£¼ì„¸ìš”'
        };
      }

      function updateSummaryHeader() {
        if (!els.summaryHeader) return;
        const epic = getActiveEpic();
        const task = getActiveTask();
        const epicName = epic ? epic.name : '-';
        const taskName = task ? task.name : '-';
        const breadcrumb = `${state.milestoneTitle || 'ë§ˆì¼ìŠ¤í†¤'} > ${epicName} > ${taskName}`;
        const stats = computeTaskStats(task);
        const releaseSignal = getReleaseSignal(stats);
        renderSummaryHeader(els.summaryHeader, { breadcrumb, stats, releaseSignal, activeAction: activeSummaryAction });
      }

      function setReportTab(tab) {
        if (!els.testCasesPanel || !els.insightsPanel || !els.reportTabs) return;
        activeReportTab = tab;
        els.testCasesPanel.classList.toggle('hidden', tab !== 'test-cases');
        els.insightsPanel.classList.toggle('hidden', tab !== 'status-report');
        els.reportTabs.querySelectorAll('[data-report-tab]').forEach((btn) => {
          const isActive = btn.dataset.reportTab === tab;
          btn.className = 'px-3 py-2 text-xs rounded-lg border ' +
            (isActive ? 'bg-slate-900 text-white' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50');
        });
      }

      function getActiveFilterKey() {
        if (!statusFilter || statusFilter.length === 0) return 'all';
        if (statusFilter.length === 1 && statusFilter[0] === 'not_test') return 'not-test';
        if (statusFilter.length === 1 && statusFilter[0] === 'na') return 'na';
        if (statusFilter.includes('fail') || statusFilter.includes('block')) return 'issues';
        return 'all';
      }

      function renderTcFilterTabs(stats) {
        if (!els.tcFilterTabs) return;
        const tabs = [
          { key: 'all', label: 'All' },
          { key: 'not-test', label: 'Not Tested' },
          { key: 'issues', label: 'Issues' },
          { key: 'na', label: 'N/A' }
        ];
        const activeKey = getActiveFilterKey();
        els.tcFilterTabs.innerHTML = tabs.map(tab => {
          const isActive = tab.key === activeKey;
          const cls = isActive
            ? 'bg-slate-900 text-white'
            : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50';
          return `<button data-filter="${tab.key}" class="px-3 py-1.5 text-xs rounded-full ${cls}">${tab.label}</button>`;
        }).join('');
      }

      function isViewAllMode() {
        return activeSummaryAction === 'all' && (!statusFilter || statusFilter.length === 0);
      }

      function updateTableEditToggleVisibility() {
        if (!els.tableEditToggle) return;
        if (!isAdmin) return;
        const shouldHide = !isViewAllMode();
        els.tableEditToggle.classList.toggle('hidden', shouldHide);
      }

      function getFilteredTcs(tcs) {
        if (!statusFilter || statusFilter.length === 0) return tcs;
        return tcs.filter(tc => statusFilter.includes(tc.status || 'not_test'));
      }

      function buildNumberMap(tcs) {
        const map = new Map();
        tcs.forEach((tc, idx) => {
          map.set(tc.id, idx + 1);
        });
        return map;
      }

      function scrollToTableTopAndFocus() {
        const reportSection = document.getElementById('reportSection');
        if (reportSection) {
          reportSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        const firstSelect = els.tcBody.querySelector('select[data-field="status"]');
        if (firstSelect) firstSelect.focus();
      }

      function renderInsights(task, stats) {
        if (!els.insightsContent) return;
        const tcs = task ? (task.tcs || []) : [];
        const safeStats = stats || computeTaskStats(task);
        const failCases = tcs.filter(tc => tc.status === 'fail');
        const blockCases = tcs.filter(tc => tc.status === 'block');
        const naCases = tcs.filter(tc => tc.status === 'na');
        const notTestCount = Number(safeStats.notTest) || 0;
        const failCount = Number(safeStats.fail) || 0;
        const blockCount = Number(safeStats.block) || 0;
        const naCount = Number(safeStats.na) || 0;
        const insightParts = [];
        if (failCount > 0) insightParts.push(`Fail ${failCount}ê±´`);
        if (blockCount > 0) insightParts.push(`Block ${blockCount}ê±´`);
        if (notTestCount > 0) insightParts.push(`Not Tested ${notTestCount}ê±´`);
        const coverageText = insightParts.length > 0
          ? `${insightParts.join('ê³¼ ')}ìœ¼ë¡œ ì•„ì§ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”.`
          : 'í˜„ì¬ í° ì´ìŠˆëŠ” ë³´ì´ì§€ ì•Šì•„ìš”. ì „ì²´ ì¼€ì´ìŠ¤ë¥¼ í™•ì¸í•˜ë©° ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”.';
        const naText = naCount > 0 ? `N/A ${naCount}ê±´ì€ ë²”ìœ„ ì œì™¸ í•­ëª©ì´ì—ìš”.` : '';
        const insightText = naText ? `${coverageText} ${naText}` : coverageText;
        const renderCaseList = (cases) => {
          if (!cases || cases.length === 0) {
            return '<p class="text-xs text-slate-500">í•´ë‹¹ ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
          return `
            <ul class="space-y-1">
              ${cases.map(tc => `
                <li class="text-xs text-slate-700">
                  <span class="font-semibold">${tc.id}</span>
                  <span class="text-slate-500">Â·</span>
                  <span>${escapeHtml(tc.content || tc.middle || 'ì œëª© ì—†ìŒ')}</span>
                </li>
              `).join('')}
            </ul>
          `;
        };
        const renderNaCaseList = (cases) => {
          if (!cases || cases.length === 0) {
            return '<p class="text-xs text-slate-500">í•´ë‹¹ ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
          return `
            <ul class="space-y-2">
              ${cases.map(tc => `
                <li class="text-xs text-slate-700">
                  <div>
                    <span class="font-semibold">${tc.id}</span>
                    <span class="text-slate-500">Â·</span>
                    <span>${escapeHtml(tc.content || tc.middle || 'ì œëª© ì—†ìŒ')}</span>
                  </div>
                  <div class="text-xs text-slate-500 mt-1">
                    ${escapeHtml(tc.memo || '(ì‚¬ìœ  ë©”ëª¨ ì—†ìŒ)')}
                  </div>
                </li>
              `).join('')}
            </ul>
          `;
        };
        els.insightsContent.innerHTML = `
          <div class="space-y-5">
            <div>
              <p class="text-sm font-semibold text-slate-800">Status Report</p>
              <p class="text-xs text-slate-600 mt-1">${insightText}</p>
            </div>
            <div class="space-y-4">
              <div class="border border-slate-200 rounded-xl p-4 bg-white">
                <div class="flex items-center justify-between mb-2">
                  <p class="text-sm font-semibold text-slate-700">Failed Cases</p>
                  <button data-report-action="filter-fail" class="text-xs px-3 py-1 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50">View Failed Cases</button>
                </div>
                ${renderCaseList(failCases)}
              </div>
              ${blockCount > 0 ? `
                <div class="border border-slate-200 rounded-xl p-4 bg-white">
                  <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-semibold text-slate-700">Blocked Cases</p>
                    <button data-report-action="filter-block" class="text-xs px-3 py-1 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50">View Blocked Cases</button>
                  </div>
                  ${renderCaseList(blockCases)}
                </div>
              ` : ''}
              <div class="border border-slate-200 rounded-xl p-4 bg-white">
                <div class="flex items-center justify-between mb-2">
                  <p class="text-sm font-semibold text-slate-700">Not Tested Cases</p>
                  <button data-report-action="filter-not-test" class="text-xs px-3 py-1 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50">View Not Tested Cases</button>
                </div>
                <p class="text-xs text-slate-600">ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì€ í…ŒìŠ¤íŠ¸ê°€ ë§ì•„ìš”. ìš°ì„ ìˆœìœ„ë¥¼ ì •í•´ ì‹¤í–‰ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.</p>
              </div>
            </div>
            <div class="border border-slate-200 rounded-xl p-4 bg-slate-50">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-sm">â„¹ï¸</span>
                <p class="text-sm font-semibold text-slate-700">N/A Cases</p>
              </div>
              ${renderNaCaseList(naCases)}
            </div>
          </div>
        `;
      }

      function closeReportModal() {
        if (!els.reportModal) return;
        els.reportModal.classList.add('hidden');
        els.reportModal.classList.remove('flex');
      }

      function renderTable() {
        const task = getActiveTask();
        const allTcs = task ? (task.tcs || []) : [];
        const tcs = getFilteredTcs(allTcs);
        const numberMap = buildNumberMap(allTcs);
        els.tcBody.innerHTML = '';

        tcs.forEach((tc, index) => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-slate-100 hover:bg-slate-50' + (isAdmin && isTableEditMode ? ' cursor-move select-none' : '');
          tr.dataset.tcId = tc.id;
          tr.draggable = isAdmin && isTableEditMode;

          tr.innerHTML = `
            <td class="py-2 px-2 text-slate-500">${numberMap.get(tc.id) || '-'}</td>
            <td class="py-2 px-2 text-slate-700">${escapeHtml(tc.middle || '')}</td>
            <td class="py-2 px-2 text-slate-700">${escapeHtml(tc.precondition || '')}</td>
            <td class="py-2 px-2 text-slate-700">${escapeHtml(tc.content || '')}</td>
            <td class="py-2 px-2 text-slate-700">${escapeHtml(tc.expected || '')}</td>
            <td class="py-2 px-2" data-cell="status"></td>
            <td class="py-2 px-2">
              <div class="flex items-center gap-2">
                <input data-field="memo" class="w-full border border-slate-300 rounded-lg px-2 py-1" value="${escapeHtml(tc.memo || '')}" ${isAdmin ? '' : 'readonly'}>
              </div>
            </td>
            <td class="py-2 px-2">
              <div class="flex items-center gap-2 ${isAdmin && isTableEditMode && isViewAllMode() ? '' : 'invisible pointer-events-none'}">
                <button data-action="delete" class="w-8 h-8 inline-flex items-center justify-center rounded bg-rose-50 text-rose-600 hover:bg-rose-100">ğŸ—‘ï¸</button>
              </div>
            </td>
          `;

          const selectCell = tr.querySelector('[data-cell="status"]');
          const select = createStatusSelect(tc.status);
          if (selectCell) selectCell.appendChild(select);
          select.dataset.field = 'status';

          els.tcBody.appendChild(tr);
          if (tc.id === lastAddedTcId) {
            tr.classList.add('row-enter');
            tr.addEventListener('animationend', () => {
              tr.classList.remove('row-enter');
              if (lastAddedTcId === tc.id) lastAddedTcId = null;
            }, { once: true });
          }
        });
        els.tcCount.textContent = `${tcs.length}ê±´`;
        updateSummaryHeader();
        renderTcFilterTabs(computeTaskStats(getActiveTask()));
        renderInsights(getActiveTask(), computeTaskStats(getActiveTask()));
      updateTableEditToggleVisibility();
      }

      function addTcRow(newTc) {
        const task = getActiveTask();
        if (!task) {
          alert('ë¨¼ì € Taskë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');
          return;
        }
        state.tcCounter += 1;
        const tcId = 'tc_' + state.tcCounter;
        task.tcs.push({
          id: tcId,
          middle: newTc.middle || '',
          precondition: newTc.precondition || '',
          content: newTc.content || '',
          expected: newTc.expected || '',
          status: newTc.status || 'not_test',
          memo: newTc.memo || ''
        });
        lastAddedTcId = tcId;
        persist();
        renderAll();
      }

      function addTcRows(rows) {
        const task = getActiveTask();
        if (!task) {
          alert('ë¨¼ì € Taskë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');
          return;
        }
        rows.forEach(row => {
          state.tcCounter += 1;
          const tcId = 'tc_' + state.tcCounter;
          task.tcs.push({
            id: tcId,
            middle: row.middle || '',
            precondition: row.precondition || '',
            content: row.content || '',
            expected: row.expected || '',
            status: row.status || 'not_test',
            memo: row.memo || ''
          });
          lastAddedTcId = tcId;
        });
        persist();
        renderAll();
      }

      function moveTc(task, fromIndex, toIndex) {
        if (fromIndex === toIndex) return;
        const item = task.tcs.splice(fromIndex, 1)[0];
        task.tcs.splice(toIndex, 0, item);
      }

      let dragTcId = null;
      let dropIndicatorRow = null;
      let dropIndicatorPos = null;
      let lastDragTime = 0;

      function updateTcRow(tcId, data) {
        const task = getActiveTask();
        const tc = task.tcs.find(t => t.id === tcId);
        if (!tc) return;
        tc.middle = data.middle || '';
        tc.precondition = data.precondition || '';
        tc.content = data.content || '';
        tc.expected = data.expected || '';
        tc.status = data.status || 'not_test';
        tc.memo = data.memo || '';
        persist();
        renderAll();
      }

      function copyTcLink(tcId) {
        const epic = getActiveEpic();
        const url = `${window.location.origin}${window.location.pathname}?epic=${encodeURIComponent(epic.name)}&tc=${encodeURIComponent(tcId)}`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(() => {
            alert('TC ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }).catch(() => {
            prompt('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ ì£¼ì„¸ìš”.', url);
          });
        } else {
          prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ ì£¼ì„¸ìš”.', url);
        }
      }

      function copyEpicLink() {
        const epic = getActiveEpic();
        const url = `${window.location.origin}${window.location.pathname}?epic=${encodeURIComponent(epic.name)}`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(() => {
            alert('ì—í”½ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }).catch(() => {
            prompt('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ ì£¼ì„¸ìš”.', url);
          });
        } else {
          prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ ì£¼ì„¸ìš”.', url);
        }
      }

      function deleteTc(tcId) {
        const task = getActiveTask();
        const ok = confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!ok) return;
        task.tcs = (task.tcs || []).filter(tc => tc.id !== tcId);
        persist();
        renderAll();
      }

      function escapeHtml(value) {
        const div = document.createElement('div');
        div.textContent = value || '';
        return div.innerHTML;
      }

      function renderAll() {
        renderEpicTabs();
        renderTaskTabs();
        renderGlobalDashboard();
        renderEpicDashboard();
        renderTable();
        setReportTab(activeReportTab);
      }

      function applyDeepLink() {
        const params = new URLSearchParams(window.location.search);
        const epicParam = params.get('epic');
        const tcId = params.get('tc');
        if (epicParam) {
          const targetEpic = state.epics.find(e => e.name === epicParam || e.id === epicParam);
          if (targetEpic) {
            state.activeEpicId = targetEpic.id;
            const firstTask = targetEpic.tasks && targetEpic.tasks[0];
            state.activeTaskId = firstTask ? firstTask.id : null;
          }
        }
        if (tcId) {
          state.epics.forEach(epic => {
            (epic.tasks || []).forEach(task => {
              const hit = (task.tcs || []).some(tc => tc.id === tcId);
              if (hit) {
                state.activeEpicId = epic.id;
                state.activeTaskId = task.id;
              }
            });
          });
        }
        renderAll();
        if (tcId) {
          const row = document.querySelector(`[data-tc-id="${tcId}"]`);
          if (row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.classList.add('highlight-row');
            setTimeout(() => row.classList.remove('highlight-row'), 3000);
          }
        }
      }

      els.addEpicBtn.addEventListener('click', () => {
        if (!isAdmin) return;
        const name = prompt('ìƒˆ ì—í”½ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        if (!name) return;
        const epic = { id: createId('epic'), name: name.trim(), jiraUrl: '', tasks: [] };
        state.epics.push(epic);
        state.activeEpicId = epic.id;
        state.activeTaskId = null;
        persist();
        renderAll();
      });

      els.addTaskBtn.addEventListener('click', () => {
        if (!isAdmin || !isTaskEditMode) return;
        const name = prompt('ìƒˆ Task ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        if (!name) return;
        const epic = getActiveEpic();
        const task = { id: createId('task'), name: name.trim(), tcs: [] };
        epic.tasks = epic.tasks || [];
        epic.tasks.push(task);
        state.activeTaskId = task.id;
        persist();
        renderAll();
      });

      els.deleteEpicBtn.addEventListener('click', () => {
        if (!isAdmin) return;
        const epic = getActiveEpic();
        if ((epic.tasks || []).length > 0) {
          alert('ì—í”½ì— Taskê°€ ë‚¨ì•„ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Taskë¥¼ ì‚­ì œí•´ ì£¼ì„¸ìš”.');
          return;
        }
        const ok = confirm(`ì—í”½ "${epic.name}" ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (!ok) return;
        state.epics = state.epics.filter(e => e.id !== epic.id);
        if (state.epics.length === 0) {
          state.epics = [{ id: createId('epic'), name: 'ì—í”½ 1', jiraUrl: '', tasks: [] }];
        }
        state.activeEpicId = state.epics[0].id;
        state.activeTaskId = state.epics[0].tasks[0] ? state.epics[0].tasks[0].id : null;
        persist();
        renderAll();
        applyRoleUI();
      });

      els.deleteTaskBtn.addEventListener('click', () => {
        if (!isAdmin) return;
        const epic = getActiveEpic();
        const task = getActiveTask();
        const ok = confirm(`Task "${task.name}" ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (!ok) return;
        epic.tasks = (epic.tasks || []).filter(t => t.id !== task.id);
        if (epic.tasks.length === 0) {
          state.activeTaskId = null;
          persist();
          renderAll();
          return;
        }
        state.activeTaskId = epic.tasks[0].id;
        persist();
        renderAll();
      });

      function openNewTcModal() {
        els.newTcMiddle.value = '';
        els.newTcPrecondition.value = '';
        els.newTcContent.value = '';
        els.newTcExpected.value = '';
        els.newTcStatus.value = 'not_test';
        els.newTcMemo.value = '';
        els.newTcModalTitle.textContent = 'ì‹ ê·œ TC ë“±ë¡';
        els.newTcModalSave.textContent = 'ì €ì¥';
        editTcId = null;
        els.newTcModal.classList.remove('hidden');
        els.newTcModal.classList.add('flex');
        els.newTcMiddle.focus();
      }

      function openEditTcModal(tcId) {
        const task = getActiveTask();
        const tc = task.tcs.find(t => t.id === tcId);
        if (!tc) return;
        els.newTcMiddle.value = tc.middle || '';
        els.newTcPrecondition.value = tc.precondition || '';
        els.newTcContent.value = tc.content || '';
        els.newTcExpected.value = tc.expected || '';
        els.newTcStatus.value = tc.status || 'not_test';
        els.newTcMemo.value = tc.memo || '';
        els.newTcModalTitle.textContent = 'TC ìˆ˜ì •';
        els.newTcModalSave.textContent = 'ìˆ˜ì •';
        editTcId = tcId;
        els.newTcModal.classList.remove('hidden');
        els.newTcModal.classList.add('flex');
        els.newTcMiddle.focus();
      }

      function closeNewTcModal() {
        els.newTcModal.classList.add('hidden');
        els.newTcModal.classList.remove('flex');
      }

      els.addTcBtn.addEventListener('click', () => {
        if (!isAdmin) return;
        openNewTcModal();
      });
      els.newTcModalClose.addEventListener('click', closeNewTcModal);
      els.newTcModalCancel.addEventListener('click', closeNewTcModal);
      els.newTcModal.addEventListener('click', (e) => {
        if (e.target === els.newTcModal) closeNewTcModal();
      });
      els.newTcModalSave.addEventListener('click', () => {
        const payload = {
          middle: els.newTcMiddle.value.trim(),
          precondition: els.newTcPrecondition.value.trim(),
          content: els.newTcContent.value.trim(),
          expected: els.newTcExpected.value.trim(),
          status: els.newTcStatus.value,
          memo: els.newTcMemo.value.trim()
        };
        if (editTcId) {
          updateTcRow(editTcId, payload);
        } else {
          addTcRow(payload);
        }
        closeNewTcModal();
      });

      function openIssueModal(tcId) {
        const task = getActiveTask();
        const tc = task.tcs.find(t => t.id === tcId);
        if (!tc) return;
        const issue = tc.issue || {};
        els.issueTitleInput.value = issue.title || '';
        els.issueContentInput.value = issue.content || '';
        els.issueSeverityInput.value = issue.severity || 'medium';
        els.issueAttachmentInput.value = '';
        els.issueAttachmentNote.textContent = issue.attachmentName ? `ê¸°ì¡´ ì²¨ë¶€: ${issue.attachmentName}` : '';
        issueTcId = tcId;
        els.issueModal.classList.remove('hidden');
        els.issueModal.classList.add('flex');
        els.issueTitleInput.focus();
      }

      function closeIssueModal() {
        els.issueModal.classList.add('hidden');
        els.issueModal.classList.remove('flex');
      }

      els.issueModalClose.addEventListener('click', closeIssueModal);
      els.issueModalCancel.addEventListener('click', closeIssueModal);
      els.issueModal.addEventListener('click', (e) => {
        if (e.target === els.issueModal) closeIssueModal();
      });
      els.issueModalSave.addEventListener('click', () => {
        if (!issueTcId) return;
        const task = getActiveTask();
        const tc = task.tcs.find(t => t.id === issueTcId);
        if (!tc) return;
        const file = els.issueAttachmentInput.files[0];
        tc.issue = {
          title: els.issueTitleInput.value.trim(),
          content: els.issueContentInput.value.trim(),
          severity: els.issueSeverityInput.value,
          attachmentName: file ? file.name : (tc.issue ? tc.issue.attachmentName : '')
        };
        persist();
        closeIssueModal();
      });

      function mapStatus(value) {
        const raw = (value || '').toString().trim().toLowerCase();
        if (!raw) return 'not_test';
        if (['pass', 'passed', 'ì„±ê³µ', 'ì™„ë£Œ'].includes(raw)) return 'pass';
        if (['fail', 'failed', 'ì‹¤íŒ¨'].includes(raw)) return 'fail';
        if (['block', 'blocked', 'ì°¨ë‹¨', 'ë³´ë¥˜'].includes(raw)) return 'block';
        if (['n/a', 'na'].includes(raw)) return 'na';
        if (['not test', 'not_test', 'untested', 'ë¯¸í…ŒìŠ¤íŠ¸', 'ë¯¸ì‹¤í–‰'].includes(raw)) return 'not_test';
        return 'not_test';
      }

      function normalizeHeader(value) {
        return (value || '').toString().replace(/\s+/g, '').trim();
      }

      function parseCsvText(text) {
        const rows = [];
        let row = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < text.length; i += 1) {
          const char = text[i];
          const next = text[i + 1];
          if (char === '"' && inQuotes && next === '"') {
            current += '"';
            i += 1;
            continue;
          }
          if (char === '"') {
            inQuotes = !inQuotes;
            continue;
          }
          if (char === ',' && !inQuotes) {
            row.push(current);
            current = '';
            continue;
          }
          if ((char === '\n' || char === '\r') && !inQuotes) {
            if (char === '\r' && next === '\n') i += 1;
            row.push(current);
            if (row.some(cell => cell !== '')) rows.push(row);
            row = [];
            current = '';
            continue;
          }
          current += char;
        }
        if (current.length > 0 || row.length > 0) {
          row.push(current);
          if (row.some(cell => cell !== '')) rows.push(row);
        }
        return rows;
      }

      function escapeCsv(value) {
        const str = (value ?? '').toString();
        if (str.includes('"') || str.includes(',') || str.includes('\n') || str.includes('\r')) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      }

      function statusLabel(value) {
        if (value === 'pass') return 'Pass';
        if (value === 'fail') return 'Fail';
        if (value === 'block') return 'Block';
        if (value === 'na') return 'N/A';
        return 'Not Tested';
      }

      function exportCurrentTaskCsv() {
        const task = getActiveTask();
        if (!task) {
          alert('ë‚´ë³´ë‚¼ Taskê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        const rows = [
          ['ì¤‘ë¶„ë¥˜', 'ì‚¬ì „ì¡°ê±´', 'í…ŒìŠ¤íŠ¸ ë‚´ìš©', 'ê¸°ëŒ€ê²°ê³¼', 'ê²°ê³¼', 'ë¹„ê³ ']
        ];
        (task.tcs || []).forEach(tc => {
          rows.push([
            tc.middle || '',
            tc.precondition || '',
            tc.content || '',
            tc.expected || '',
            statusLabel(tc.status),
            tc.memo || ''
          ]);
        });
        const csv = rows.map(row => row.map(escapeCsv).join(',')).join('\n');
        const csvWithBom = '\uFEFF' + csv;
        const blob = new Blob([csvWithBom], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `task_${(task.name || 'task').replace(/\s+/g, '_')}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function parseExcelRows(rows) {
        if (!rows || rows.length === 0) return [];
        const headerIndex = rows.findIndex(row => row && row.some(cell => normalizeHeader(cell).includes('ì¤‘ë¶„ë¥˜')));
        const startIndex = headerIndex >= 0 ? headerIndex + 1 : 0;
        const headerRow = headerIndex >= 0 ? rows[headerIndex] : [];
        const headerMap = {};
        headerRow.forEach((cell, idx) => {
          const key = normalizeHeader(cell);
          if (key) headerMap[key] = idx;
        });

        const idxMiddle = headerMap['ì¤‘ë¶„ë¥˜'];
        const idxPre = headerMap['ì‚¬ì „ì¡°ê±´'];
        const idxContent = headerMap['í…ŒìŠ¤íŠ¸ë‚´ìš©'];
        const idxExpected = headerMap['ê¸°ëŒ€ê²°ê³¼'];
        const idxStatus = headerMap['ê²°ê³¼'];
        const idxMemo = headerMap['ë¹„ê³ '];

        const parsed = [];
        rows.slice(startIndex).forEach(row => {
          if (!row || row.length === 0) return;
          const content = idxContent !== undefined ? row[idxContent] : row[3];
          if (!content) return;
          parsed.push({
            middle: idxMiddle !== undefined ? row[idxMiddle] : row[1],
            precondition: idxPre !== undefined ? row[idxPre] : row[2],
            content: content,
            expected: idxExpected !== undefined ? row[idxExpected] : row[4],
            status: mapStatus(idxStatus !== undefined ? row[idxStatus] : ''),
            memo: idxMemo !== undefined ? row[idxMemo] : ''
          });
        });
        return parsed;
      }

      function handleCsvFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const rows = parseCsvText(evt.target.result || '');
            const parsed = parseExcelRows(rows);
            if (parsed.length === 0) {
              alert('ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í—¤ë”/ë‚´ìš©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
              return;
            }
            addTcRows(parsed);
          } catch (err) {
            alert(`CSV ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'})`);
          } finally {
            els.csvFileInput.value = '';
          }
        };
        reader.readAsText(file);
      }

      els.importCsvBtn.addEventListener('click', () => {
        if (!isAdmin) return;
        els.csvFileInput.click();
      });
      els.csvFileInput.addEventListener('change', (e) => {
        if (!isAdmin) return;
        handleCsvFile(e.target.files[0]);
      });
      els.exportCsvBtn.addEventListener('click', () => {
        if (!isAdmin || !isTableEditMode) return;
        exportCurrentTaskCsv();
      });

      els.tableEditToggle.addEventListener('click', () => {
        if (!isAdmin) return;
        isTableEditMode = !isTableEditMode;
        els.tableEditToggle.textContent = isTableEditMode ? 'í¸ì§‘ ì¢…ë£Œ' : 'í¸ì§‘';
        els.tableEditToggle.className = 'text-xs font-semibold px-3 py-1 rounded-full ' +
          (isTableEditMode ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600');
        renderTable();
        applyRoleUI();
      });

      els.epicEditToggle.addEventListener('click', () => {
        if (!isAdmin) return;
        isEpicEditMode = !isEpicEditMode;
        els.epicEditToggle.textContent = isEpicEditMode ? 'í¸ì§‘ ì¢…ë£Œ' : 'í¸ì§‘';
        els.epicEditToggle.className = 'text-xs font-semibold px-3 py-1 rounded-full ' +
          (isEpicEditMode ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600');
        applyEpicTaskEditUI();
      });

      els.taskEditToggle.addEventListener('click', () => {
        if (!isAdmin) return;
        isTaskEditMode = !isTaskEditMode;
        els.taskEditToggle.textContent = isTaskEditMode ? 'í¸ì§‘ ì¢…ë£Œ' : 'í¸ì§‘';
        els.taskEditToggle.className = 'text-xs font-semibold px-3 py-1 rounded-full ' +
          (isTaskEditMode ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600');
        renderTaskTabs();
        applyEpicTaskEditUI();
      });

      els.summaryHeader.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if (!action) return;
        if (action === 'issues-link') {
          statusFilter = ['fail', 'block'];
          activeSummaryAction = 'issues';
          renderTable();
        }
      });

      if (els.reportTabs) {
        els.reportTabs.addEventListener('click', (e) => {
          const tab = e.target.dataset.reportTab;
          if (!tab) return;
          setReportTab(tab);
        });
      }

      if (els.tcFilterTabs) {
        els.tcFilterTabs.addEventListener('click', (e) => {
          const key = e.target.dataset.filter;
          if (!key) return;
          if (key === 'all') {
            statusFilter = null;
            activeSummaryAction = 'all';
            renderTable();
            setReportTab('test-cases');
            return;
          }
          if (key === 'not-test') {
            statusFilter = ['not_test'];
            activeSummaryAction = 'not-test';
            renderTable();
            setReportTab('test-cases');
            setTimeout(scrollToTableTopAndFocus, 0);
            return;
          }
          if (key === 'issues') {
            statusFilter = ['fail', 'block'];
            activeSummaryAction = 'issues';
            renderTable();
            return;
          }
          if (key === 'na') {
            statusFilter = ['na'];
            activeSummaryAction = 'na';
            renderTable();
            setReportTab('test-cases');
          }
        });
      }

      if (els.reportModalClose) els.reportModalClose.addEventListener('click', closeReportModal);
      if (els.reportModalOk) els.reportModalOk.addEventListener('click', closeReportModal);
      if (els.reportModal) {
        els.reportModal.addEventListener('click', (e) => {
          if (e.target === els.reportModal) closeReportModal();
        });
      }
      if (els.insightsContent) {
        els.insightsContent.addEventListener('click', (e) => {
        const action = e.target.dataset.reportAction;
        if (!action) return;
        if (action === 'filter-fail') {
          statusFilter = ['fail'];
          activeSummaryAction = 'issues';
          renderTable();
          setReportTab('test-cases');
        }
        if (action === 'filter-block') {
          statusFilter = ['block'];
          activeSummaryAction = 'issues';
          renderTable();
          setReportTab('test-cases');
        }
        if (action === 'filter-not-test') {
          statusFilter = ['not_test'];
          activeSummaryAction = 'not-test';
          renderTable();
          setReportTab('test-cases');
          setTimeout(scrollToTableTopAndFocus, 0);
        }
        });
      }

      els.tcBody.addEventListener('input', (e) => {
        if (!isAdmin) return;
        const field = e.target.dataset.field;
        const row = e.target.closest('tr');
        if (!field || !row) return;
        const task = getActiveTask();
        const tc = task.tcs.find(t => t.id === row.dataset.tcId);
        if (!tc) return;
        tc[field] = e.target.value;
        persist();
        if (field === 'status') {
          renderGlobalDashboard();
          renderEpicDashboard();
        }
      });

      els.tcBody.addEventListener('change', (e) => {
        if (!isAdmin) return;
        if (e.target.dataset.field === 'status') {
          const row = e.target.closest('tr');
          const task = getActiveTask();
          const tc = task.tcs.find(t => t.id === row.dataset.tcId);
          if (!tc) return;
          tc.status = e.target.value;
          applyStatusStyle(e.target);
          persist();
          renderGlobalDashboard();
          renderEpicDashboard();
          updateSummaryHeader();
        if (tc.status === 'fail' || tc.status === 'block') {
            openIssueModal(tc.id);
          }
        }
      });

      els.tcBody.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        const row = e.target.closest('tr');
        if (!action || !row) return;
        if (!isAdmin && action === 'delete') return;
        const tcId = row.dataset.tcId;
        if (action === 'copy') copyTcLink(tcId);
        if (action === 'delete') {
          if (!isViewAllMode()) {
            alert('TC ì‚­ì œëŠ” View Allì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. View Allë¡œ ì „í™˜í•´ ì£¼ì„¸ìš”.');
            return;
          }
          deleteTc(tcId);
        }
      });

      els.tcBody.addEventListener('dblclick', (e) => {
        if (!isAdmin) return;
        if (!isTableEditMode) return;
        if (!isViewAllMode()) {
          alert('TC í¸ì§‘ì€ View Allì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. View Allë¡œ ì „í™˜í•´ ì£¼ì„¸ìš”.');
          return;
        }
        if (e.target.closest('input, textarea, select, button, a')) return;
        if (Date.now() - lastDragTime < 200) return;
        const row = e.target.closest('tr');
        if (!row) return;
        openEditTcModal(row.dataset.tcId);
      });

      els.tcBody.addEventListener('dragstart', (e) => {
        if (!isAdmin || !isTableEditMode) return;
        if (e.target.closest('input, textarea, select, button, a')) return;
        const row = e.target.closest('tr');
        if (!row) return;
        dragTcId = row.dataset.tcId;
        row.classList.add('opacity-60');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', dragTcId);
        lastDragTime = Date.now();
      });

      els.tcBody.addEventListener('dragend', (e) => {
        const row = e.target.closest('tr');
        if (row) row.classList.remove('opacity-60');
        if (dropIndicatorRow) {
          dropIndicatorRow.classList.remove('drop-indicator-top', 'drop-indicator-bottom');
        }
        dropIndicatorRow = null;
        dropIndicatorPos = null;
        dragTcId = null;
      });

      els.tcBody.addEventListener('dragover', (e) => {
        if (!isAdmin || !isTableEditMode || !dragTcId) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const row = e.target.closest('tr');
        if (!row) return;
        const rect = row.getBoundingClientRect();
        const isTop = e.clientY < rect.top + rect.height / 2;
        const pos = isTop ? 'top' : 'bottom';
        if (dropIndicatorRow && dropIndicatorRow !== row) {
          dropIndicatorRow.classList.remove('drop-indicator-top', 'drop-indicator-bottom');
        }
        dropIndicatorRow = row;
        dropIndicatorPos = pos;
        row.classList.toggle('drop-indicator-top', isTop);
        row.classList.toggle('drop-indicator-bottom', !isTop);
      });

      els.tcBody.addEventListener('drop', (e) => {
        if (!isAdmin || !isTableEditMode || !dragTcId) return;
        e.preventDefault();
        const targetRow = e.target.closest('tr');
        if (!targetRow) return;
        const task = getActiveTask();
        const fromIndex = task.tcs.findIndex(t => t.id === dragTcId);
        let toIndex = task.tcs.findIndex(t => t.id === targetRow.dataset.tcId);
        if (dropIndicatorPos === 'bottom') toIndex += 1;
        if (fromIndex === -1 || toIndex === -1) return;
        if (fromIndex < toIndex) toIndex -= 1;
        toIndex = Math.max(0, Math.min(task.tcs.length - 1, toIndex));
        moveTc(task, fromIndex, toIndex);
        persist();
        renderAll();
        if (dropIndicatorRow) {
          dropIndicatorRow.classList.remove('drop-indicator-top', 'drop-indicator-bottom');
        }
        dropIndicatorRow = null;
        dropIndicatorPos = null;
      });

      els.copyEpicLink.addEventListener('click', copyEpicLink);

      els.epicTitleDisplay.addEventListener('click', () => {
        const epic = getActiveEpic();
        if (!epic.jiraUrl) {
          alert('ì—í”½ Jira URLì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        window.open(epic.jiraUrl, '_blank', 'noopener');
      });

      if (els.epicTitleInput) els.epicTitleInput.addEventListener('input', (e) => {
        if (!isAdmin) return;
        const epic = getActiveEpic();
        epic.name = e.target.value.trim() || 'ì—í”½';
        persist();
        renderAll();
      });

      if (els.epicJiraUrl) els.epicJiraUrl.addEventListener('input', (e) => {
        if (!isAdmin) return;
        const epic = getActiveEpic();
        epic.jiraUrl = e.target.value.trim();
        persist();
      });

      function updateMilestoneUI() {
        els.milestoneTitleDisplay.textContent = state.milestoneTitle || DEFAULT_MILESTONE_TITLE;
        if (state.milestoneJiraUrl) {
          els.milestoneJiraBadge.classList.remove('hidden');
          els.milestoneJiraBadge.href = state.milestoneJiraUrl;
        } else {
          els.milestoneJiraBadge.classList.add('hidden');
          els.milestoneJiraBadge.removeAttribute('href');
        }
      }

      function openMilestoneModal() {
        els.milestoneModalTitleInput.value = state.milestoneTitle || DEFAULT_MILESTONE_TITLE;
        els.milestoneModalJiraInput.value = state.milestoneJiraUrl || '';
        els.milestoneModal.classList.remove('hidden');
        els.milestoneModal.classList.add('flex');
        els.milestoneModalTitleInput.focus();
      }

      function closeMilestoneModal() {
        els.milestoneModal.classList.add('hidden');
        els.milestoneModal.classList.remove('flex');
      }

      els.milestoneTitleDisplay.addEventListener('click', () => {
        if (isAdmin) {
          openMilestoneModal();
          return;
        }
        if (state.milestoneJiraUrl) {
          window.open(state.milestoneJiraUrl, '_blank', 'noopener');
        }
      });
      els.milestoneModalClose.addEventListener('click', closeMilestoneModal);
      els.milestoneModalCancel.addEventListener('click', closeMilestoneModal);
      els.milestoneModal.addEventListener('click', (e) => {
        if (e.target === els.milestoneModal) closeMilestoneModal();
      });

      els.milestoneModalSave.addEventListener('click', () => {
        state.milestoneTitle = els.milestoneModalTitleInput.value.trim() || DEFAULT_MILESTONE_TITLE;
        state.milestoneJiraUrl = els.milestoneModalJiraInput.value.trim();
        persist();
        updateMilestoneUI();
        closeMilestoneModal();
      });

      function applyRoleUI() {
        els.modeBadge.textContent = isAdmin ? 'ê´€ë¦¬ì ëª¨ë“œ' : 'ë·°ì–´ ëª¨ë“œ';
        els.modeBadge.className = 'text-xs font-semibold px-3 py-1 rounded-full ' +
          (isAdmin ? 'bg-indigo-50 text-indigo-600' : 'bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600');
        if (els.adminPageBtn) {
          els.adminPageBtn.classList.toggle('hidden', !isAdmin);
        }
        if (!isAdmin) {
          els.addEpicBtn.classList.add('hidden');
          els.deleteEpicBtn.classList.add('hidden');
          els.deleteTaskBtn.classList.add('hidden');
          els.epicEditToggle.classList.add('hidden');
          els.taskEditToggle.classList.add('hidden');
          els.tableEditToggle.classList.add('hidden');
          els.importCsvBtn.classList.add('hidden');
          els.exportCsvBtn.classList.add('hidden');
          els.addTcBtn.classList.add('hidden');
          if (els.epicTitleInput) els.epicTitleInput.classList.add('hidden');
          if (els.epicJiraUrl) els.epicJiraUrl.classList.add('hidden');
          els.modeBadge.classList.add('cursor-pointer');
        } else {
          els.modeBadge.classList.remove('cursor-pointer');
          els.tableEditToggle.classList.remove('hidden');
          els.epicEditToggle.classList.remove('hidden');
          els.taskEditToggle.classList.remove('hidden');
          els.addEpicBtn.classList.remove('hidden');
          els.deleteEpicBtn.classList.remove('hidden');
          els.deleteTaskBtn.classList.remove('hidden');
          els.importCsvBtn.classList.remove('hidden');
          els.exportCsvBtn.classList.remove('hidden');
          els.addTcBtn.classList.remove('hidden');
        }
        applyEpicTaskEditUI();
        updateTableEditToggleVisibility();
        if (isAdmin) {
          const hideForEdit = !isTableEditMode;
          els.importCsvBtn.classList.toggle('invisible', hideForEdit);
          els.exportCsvBtn.classList.toggle('invisible', hideForEdit);
          els.addTcBtn.classList.toggle('invisible', hideForEdit);
          els.importCsvBtn.classList.toggle('pointer-events-none', hideForEdit);
          els.exportCsvBtn.classList.toggle('pointer-events-none', hideForEdit);
          els.addTcBtn.classList.toggle('pointer-events-none', hideForEdit);
        }
      }

      function setLoginError(message) {
        if (!els.loginError) return;
        if (!message) {
          els.loginError.classList.add('hidden');
          els.loginError.textContent = '';
          return;
        }
        els.loginError.textContent = message;
        els.loginError.classList.remove('hidden');
      }

      async function ensureUserProfile(user) {
        if (!fb || !fb.db) throw new Error('Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        const userRef = fb.db.collection('users').doc(user.uid);
        const snap = await userRef.get();
        if (snap.exists) {
          if (user.email === ADMIN_EMAIL) {
            await userRef.set({
              email: user.email,
              role: 'Admin',
              status: 'Approved',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            const refreshed = await userRef.get();
            return refreshed.data();
          }
          return snap.data();
        }
        const payload = {
          email: user.email,
          role: user.email === ADMIN_EMAIL ? 'Admin' : 'Guest',
          status: user.email === ADMIN_EMAIL ? 'Approved' : 'Pending',
          requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await userRef.set(payload);
        return payload;
      }

      async function fetchPendingRequest(uid) {
        if (!fb || !fb.db) return null;
        const query = await fb.db.collection('access_requests')
          .where('uid', '==', uid)
          .where('status', '==', 'Pending')
          .orderBy('requestedAt', 'desc')
          .limit(1)
          .get();
        if (query.empty) return null;
        const doc = query.docs[0];
        return { id: doc.id, ...doc.data() };
      }

      async function sendRequestEmail(payload) {
        if (!projectId) return;
        const url = `https://us-central1-${projectId}.cloudfunctions.net/notifyAccessRequest`;
        try {
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (err) {
          console.warn('ê¶Œí•œ ìš”ì²­ ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨', err);
        }
      }

      async function submitAccessRequest(type) {
        if (!fb || !fb.db || !fb.auth.currentUser) return;
        const user = fb.auth.currentUser;
        if (els.requestStatus) els.requestStatus.textContent = 'ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';

        const pending = await fetchPendingRequest(user.uid);
        if (pending) {
          if (els.requestStatus) els.requestStatus.textContent = 'ì´ë¯¸ ê¶Œí•œ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
          return;
        }

        const payload = {
          uid: user.uid,
          email: user.email,
          type,
          status: 'Pending',
          requestedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await fb.db.collection('access_requests').add(payload);
        await fb.db.collection('users').doc(user.uid).set({
          email: user.email,
          role: 'Guest',
          status: 'Pending',
          requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        if (els.requestStatus) els.requestStatus.textContent = 'ê¶Œí•œ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.';
        await sendRequestEmail({ email: user.email, type });
      }

      function formatTimestamp(ts) {
        if (!ts || !ts.toDate) return '-';
        return ts.toDate().toLocaleString();
      }

      function renderAdminRequests(rows) {
        if (!els.adminRequestsBody || !els.adminEmpty) return;
        els.adminRequestsBody.innerHTML = '';
        if (!rows || rows.length === 0) {
          els.adminEmpty.classList.remove('hidden');
          return;
        }
        els.adminEmpty.classList.add('hidden');
        rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-slate-100';
          tr.innerHTML = `
            <td class="py-2 px-2 text-slate-700">${row.email || '-'}</td>
            <td class="py-2 px-2 text-slate-600">${row.type || '-'}</td>
            <td class="py-2 px-2 text-slate-600">${row.status || '-'}</td>
            <td class="py-2 px-2 text-slate-500">${formatTimestamp(row.requestedAt)}</td>
            <td class="py-2 px-2">
              <div class="flex items-center gap-2">
                <button data-admin-action="approve" data-id="${row.id}" data-email="${row.email}" data-uid="${row.uid}" data-type="${row.type}" class="px-3 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">ìˆ˜ë½</button>
                <button data-admin-action="reject" data-id="${row.id}" data-email="${row.email}" data-uid="${row.uid}" data-type="${row.type}" class="px-3 py-1 text-xs rounded-full bg-rose-50 text-rose-700 border border-rose-200">ê±°ì ˆ</button>
              </div>
            </td>
          `;
          els.adminRequestsBody.appendChild(tr);
        });
      }

      async function loadAdminRequests() {
        if (!fb || !fb.db) return;
        const query = await fb.db.collection('access_requests')
          .where('status', '==', 'Pending')
          .orderBy('requestedAt', 'desc')
          .get();
        const rows = query.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAdminRequests(rows);
      }

      async function handleAuthState(user) {
        if (!user) {
          isAdmin = false;
          applyRoleUI();
          showLoginScreen();
          setLoginError('');
          if (els.loginBtn) els.loginBtn.classList.remove('hidden');
          if (els.logoutBtn) els.logoutBtn.classList.add('hidden');
          return;
        }

        try {
          if (!fb || !fb.db) {
            showLoginScreen();
            setLoginError('Firestore ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            return;
          }
          const profile = await ensureUserProfile(user);
          const approved = profile.status === 'Approved';
          const role = profile.role || 'Guest';
          if (approved && (role === 'Viewer' || role === 'Admin')) {
            isAdmin = role === 'Admin';
            applyRoleUI();
            showApp();
            renderAll();
            closeRequestModal();
            if (isAdmin) loadAdminRequests();
          } else {
            isAdmin = false;
            applyRoleUI();
            showLoginScreen();
            if (els.loginBtn) els.loginBtn.classList.add('hidden');
            if (els.logoutBtn) els.logoutBtn.classList.remove('hidden');
            setLoginError('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œ ìš”ì²­ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.');
            openRequestModal();
            const pending = await fetchPendingRequest(user.uid);
            if (els.requestStatus) {
              els.requestStatus.textContent = pending
                ? 'ì´ë¯¸ ê¶Œí•œ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.'
                : '';
            }
          }
        } catch (err) {
          console.error(err);
          showLoginScreen();
          const detail = err && (err.message || err.code || err.toString && err.toString());
          setLoginError(`ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ${detail ? '(' + detail + ')' : 'ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.'}`);
        }
      }

      if (!state.activeEpicId && state.epics.length > 0) {
        state.activeEpicId = state.epics[0].id;
      }
      if (!state.activeTaskId && state.epics.length > 0) {
        const firstTask = state.epics[0].tasks && state.epics[0].tasks[0];
        state.activeTaskId = firstTask ? firstTask.id : null;
      }
      updateMilestoneUI();
      applyRoleUI();
      showLoginScreen();

      // Firebase ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ í™”ë©´ ì „í™˜
      if (fb) {
        fb.onAuthStateChanged(handleAuthState);
      } else {
        showLoginScreen();
        setLoginError('Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      if (els.loginBtn) {
        els.loginBtn.addEventListener('click', async () => {
          if (!fb) {
            setLoginError('Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return;
          }
          if (isAuthBusy) return;
          isAuthBusy = true;
          els.loginBtn.disabled = true;
          els.loginBtn.classList.add('opacity-60', 'pointer-events-none');
          try {
            await fb.signInWithPopup(fb.provider);
          } catch (e) {
            setLoginError('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (e?.message || e));
          } finally {
            isAuthBusy = false;
            els.loginBtn.disabled = false;
            els.loginBtn.classList.remove('opacity-60', 'pointer-events-none');
          }
        });
      }

      if (els.logoutBtn) {
        els.logoutBtn.addEventListener('click', async () => {
          if (!fb) return;
          try {
            await fb.signOut();
            showLoginScreen();
            setLoginError('');
          } catch (e) {
            setLoginError('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + (e?.message || e));
          }
        });
      }

      if (els.modeBadge) {
        els.modeBadge.addEventListener('click', async () => {
          if (!fb || !fb.auth.currentUser) return;
          try {
            await fb.signOut();
            showLoginScreen();
            setLoginError('');
          } catch (e) {
            alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + (e?.message || e));
          }
        });
      }

      if (els.requestModalClose) {
        els.requestModalClose.addEventListener('click', closeRequestModal);
      }
      if (els.requestModal) {
        els.requestModal.addEventListener('click', (e) => {
          if (e.target === els.requestModal) closeRequestModal();
        });
      }
      if (els.requestViewerBtn) {
        els.requestViewerBtn.addEventListener('click', () => submitAccessRequest('Viewer'));
      }
      if (els.requestAdminBtn) {
        els.requestAdminBtn.addEventListener('click', () => submitAccessRequest('Admin'));
      }

      if (els.adminPageBtn) {
        els.adminPageBtn.addEventListener('click', () => {
          showAdminSection();
          loadAdminRequests();
        });
      }
      if (els.adminBackBtn) {
        els.adminBackBtn.addEventListener('click', () => {
          showApp();
        });
      }
      if (els.adminRequestsBody) {
        els.adminRequestsBody.addEventListener('click', async (e) => {
          if (!isAdmin) return;
          const btn = e.target.closest('button[data-admin-action]');
          if (!btn) return;
          const action = btn.dataset.adminAction;
          const requestId = btn.dataset.id;
          const uid = btn.dataset.uid;
          const type = btn.dataset.type;
          const now = firebase.firestore.FieldValue.serverTimestamp();
          if (action === 'approve') {
            await fb.db.collection('access_requests').doc(requestId).update({
              status: 'Approved',
              resolvedAt: now
            });
            await fb.db.collection('users').doc(uid).set({
              email: btn.dataset.email,
              role: type === 'Admin' ? 'Admin' : 'Viewer',
              status: 'Approved',
              updatedAt: now
            }, { merge: true });
            loadAdminRequests();
          }
          if (action === 'reject') {
            await fb.db.collection('access_requests').doc(requestId).update({
              status: 'Rejected',
              resolvedAt: now
            });
            await fb.db.collection('users').doc(uid).set({
              status: 'Rejected',
              role: 'Guest',
              updatedAt: now
            }, { merge: true });
            loadAdminRequests();
          }
        });
      }

      function openAdminLogin() {
        if (!els.adminLoginModal) return;
        els.adminLoginId.value = '';
        els.adminLoginPw.value = '';
        els.adminLoginError.classList.add('hidden');
        els.adminLoginModal.classList.remove('hidden');
        els.adminLoginModal.classList.add('flex');
        els.adminLoginId.focus();
      }

      function closeAdminLogin() {
        if (!els.adminLoginModal) return;
        els.adminLoginModal.classList.add('hidden');
        els.adminLoginModal.classList.remove('flex');
      }

      function openAdminLogout() {
        if (!els.adminLogoutModal) return;
        els.adminLogoutModal.classList.remove('hidden');
        els.adminLogoutModal.classList.add('flex');
      }

      function closeAdminLogout() {
        if (!els.adminLogoutModal) return;
        els.adminLogoutModal.classList.add('hidden');
        els.adminLogoutModal.classList.remove('flex');
      }

      if (els.adminLoginClose) els.adminLoginClose.addEventListener('click', closeAdminLogin);
      if (els.adminLoginCancel) els.adminLoginCancel.addEventListener('click', closeAdminLogin);
      if (els.adminLoginModal) {
        els.adminLoginModal.addEventListener('click', (e) => {
          if (e.target === els.adminLoginModal) closeAdminLogin();
        });
      }
      if (els.adminLoginSubmit) {
        els.adminLoginSubmit.addEventListener('click', () => {
          alert('ì´ ë¡œê·¸ì¸ì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒë‹¨ ë±ƒì§€(ë·°ì–´ ëª¨ë“œ)ë¥¼ ëˆŒëŸ¬ Google ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
        });
      }

      if (els.adminLogoutClose) els.adminLogoutClose.addEventListener('click', closeAdminLogout);
      if (els.adminLogoutCancel) els.adminLogoutCancel.addEventListener('click', closeAdminLogout);
      if (els.adminLogoutModal) {
        els.adminLogoutModal.addEventListener('click', (e) => {
          if (e.target === els.adminLogoutModal) closeAdminLogout();
        });
      }
      if (els.adminLogoutConfirm) {
        els.adminLogoutConfirm.addEventListener('click', () => {
          localStorage.removeItem('qa_tms_admin');
          isAdmin = false;
          applyRoleUI();
          renderAll();
          closeAdminLogout();
        });
      }
      document.querySelectorAll('.section-link').forEach((btn) => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const target = document.getElementById(targetId);
          if (!target) return;
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });

      applyDeepLink();
    })();
  </script>
</body>
</html>
